<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debouncing a FutureProvider</title>
    <link rel="shortcut icon" type="image/jpg" href="/img/favicon.png"/>
    <meta name="description" content="A quick quide on how to implement a debounce functionality for a FutureProvider">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-vsc-dark-plus.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Michael Debertol">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Michael Debertol">
    <link rel="preload" href="/fonts/Roboto_Slab/RobotoSlab-VariableFont_wght.ttf" as="font" type="font/ttf" crossorigin>
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">Michael Debertol</a></h1>
      <ul class="nav">
        <li class="nav-item "><a href="/">Home</a></li>
        <li class="nav-item "><a href="/tags/">Tags</a></li>
        <li class="nav-item "><a href="/about/">About</a></li>
      </ul>
    </header>

    <main  class="tmpl-post">
      <h1>Debouncing a FutureProvider</h1>

<time datetime="2022-06-16">16. Juni 2022</time><a href="/tags/flutter/" class="post-tag animated-rainbow-hover">Flutter</a><a href="/tags/riverpod/" class="post-tag animated-rainbow-hover">Riverpod</a>

<p>Note: This is mostly copied from an <a href="https://github.com/rrousselGit/riverpod/blob/master/examples/marvel/lib/src/screens/home.dart">official example</a>.</p>
<h2 id="when-to-debounce" tabindex="-1"><a class="direct-link" href="#when-to-debounce">When to Debounce</a></h2>
<p>Debouncing can be useful whenever a provider relies on user input that can change quickly, like a search query.</p>
<h2 id="how-to-debounce" tabindex="-1"><a class="direct-link" href="#how-to-debounce">How to Debounce</a></h2>
<p>Let's look right at the code:</p>
<pre class="language-dart"><code class="language-dart"><span class="highlight-line"><span class="token comment">/// This exception indicates that a request has been aborted.</span></span><br><span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">AbortedException</span> <span class="token keyword">implements</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">final</span> itemProvider <span class="token operator">=</span> <span class="token class-name">FutureProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">></span></span><span class="token punctuation">(</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token comment">// Get the search query that the user entered</span></span><br><span class="highlight-line">    <span class="token keyword">final</span> query <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>queryProvider<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active">    <span class="token comment">// If this provider is destroyed (i.e. a new provider for a different</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token comment">// request is created), we should abort this request.</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">var</span> shouldAbort <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">    ref<span class="token punctuation">.</span><span class="token function">onDispose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">      shouldAbort <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">await</span> <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span>_debounceDuration<span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldAbort<span class="token punctuation">)</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token comment">// TODO: abort</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">}</span></mark><br><span class="highlight-line">    </span><br><span class="highlight-line">    <span class="token comment">// Fetch the items</span></span><br><span class="highlight-line">    <span class="token keyword">return</span> <span class="token function">fetchItems</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p><a href="https://pub.dev/documentation/riverpod/latest/riverpod/Ref/onDispose.html"><code>ref.onDispose</code></a> allows us to register a callback that is triggered whenever a provider is about to be destroyed.
The provider will be destroyed whenever a new provider is created for a different query. If, after a delay, we notice that the provider has been destroyed, we can abort the request.</p>
<h2 id="aborting-a-request-by-throwing-an-exception" tabindex="-1"><a class="direct-link" href="#aborting-a-request-by-throwing-an-exception">Aborting a Request by Throwing an Exception</a></h2>
<p>One way to abort a request is by throwing an exception:</p>
<pre class="language-dart"><code class="language-dart"><span class="highlight-line"><span class="token comment">/// This exception indicates that a request has been aborted.</span></span><br><span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">AbortedException</span> <span class="token keyword">implements</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">final</span> itemProvider <span class="token operator">=</span> <span class="token class-name">FutureProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token comment">// Get the search query that the user entered</span></span><br><span class="highlight-line">    <span class="token keyword">final</span> query <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>queryProvider<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token comment">// If this provider is destroyed (i.e. a new provider for a different</span></span><br><span class="highlight-line">    <span class="token comment">// request is created), we should abort this request.</span></span><br><span class="highlight-line">    <span class="token keyword">var</span> shouldAbort <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    ref<span class="token punctuation">.</span><span class="token function">onDispose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      shouldAbort <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token keyword">await</span> <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span>_debounceDuration<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldAbort<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><mark class="highlight-line highlight-line-active">      <span class="token keyword">throw</span> <span class="token class-name">AbortedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">    </span><br><span class="highlight-line">    <span class="token comment">// Fetch the items</span></span><br><span class="highlight-line">    <span class="token keyword">return</span> <span class="token function">fetchItems</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>In this example we're creating a custom <code>AbortedException</code> class that makes
our code a bit more readable and makes it clear that we're throwing an Exception to abort the request, not because of an actual error.</p>
<p>Since the provider was disposed its result will be ignored and throwing an <code>Exception</code> will not affect the rest of the app.
It will however show up when you debug the app and you have &quot;break on exceptions&quot; enabled, which can be a bit annoying.</p>
<h3 id="creating-a-convenience-method" tabindex="-1"><a class="direct-link" href="#creating-a-convenience-method">Creating a Convenience Method</a></h3>
<p>This approach is very general and we can extract the logic from above into a convenience method that we can reuse:</p>
<pre class="language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">AbortedException</span> <span class="token keyword">implements</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br><br><span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">void</span><span class="token punctuation">></span></span> <span class="token function">providerDebounce</span><span class="token punctuation">(</span><span class="token class-name">Duration</span> debounceDuration<span class="token punctuation">,</span> <span class="token class-name">Ref</span> ref<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> shouldAbort <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>  ref<span class="token punctuation">.</span><span class="token function">onDispose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    shouldAbort <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">await</span> <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span>debounceDuration<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldAbort<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">throw</span> <span class="token class-name">AbortedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Debouncing is now as straightforward as calling <code>await providerDebounce(_debounceDuration, ref);</code> in the provider.</p>
<p>Our <code>itemProvider</code> would now look like this:</p>
<pre class="language-dart"><code class="language-dart"><span class="highlight-line"><span class="token keyword">final</span> itemProvider <span class="token operator">=</span> <span class="token class-name">FutureProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">></span></span><span class="token punctuation">(</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token comment">// Get the search query that the user entered</span></span><br><span class="highlight-line">    <span class="token keyword">final</span> query <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>queryProvider<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">await</span> <span class="token function">providerDebounce</span><span class="token punctuation">(</span>_debounceDuration<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><span class="highlight-line">    </span><br><span class="highlight-line">    <span class="token comment">// Fetch the items</span></span><br><span class="highlight-line">    <span class="token keyword">return</span> <span class="token function">fetchItems</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<h2 id="aborting-without-exceptions" tabindex="-1"><a class="direct-link" href="#aborting-without-exceptions">Aborting Without Exceptions</a></h2>
<p>Instead of throwing an <code>Exception</code> to abort we can also return a dummy value:</p>
<pre class="language-dart"><code class="language-dart"><span class="highlight-line"><span class="token keyword">final</span> itemProvider <span class="token operator">=</span> <span class="token class-name">FutureProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token comment">// Get the search query that the user entered</span></span><br><span class="highlight-line">    <span class="token keyword">final</span> query <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>queryProvider<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token comment">// If this provider is destroyed (i.e. a new provider for a different</span></span><br><span class="highlight-line">    <span class="token comment">// request is created), we should abort this request.</span></span><br><span class="highlight-line">    <span class="token keyword">var</span> shouldAbort <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    ref<span class="token punctuation">.</span><span class="token function">onDispose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      shouldAbort <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token keyword">await</span> <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span>_debounceDuration<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldAbort<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><mark class="highlight-line highlight-line-active">      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></mark><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">    </span><br><span class="highlight-line">    <span class="token comment">// Fetch the items</span></span><br><span class="highlight-line">    <span class="token keyword">return</span> <span class="token function">fetchItems</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Here we're returning an empty list. This return value will be ignored, but most importantly, the request further down will
not be initiated.</p>
<p>Another possibility is to return a <code>Future</code> that never completes. This can be achieved using <code>Completer&lt;List&lt;Item&gt;&gt;().future</code>.</p>
<h3 id="creating-a-convenience-method-1" tabindex="-1"><a class="direct-link" href="#creating-a-convenience-method-1">Creating a Convenience Method</a></h3>
<p>For this approach a convenience method will have to look like this:</p>
<pre class="language-dart"><code class="language-dart"><span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span>bool<span class="token punctuation">></span></span> <span class="token function">providerDebounce</span><span class="token punctuation">(</span><span class="token class-name">Duration</span> debounceDuration<span class="token punctuation">,</span> <span class="token class-name">Ref</span> ref<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> shouldAbort <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>  ref<span class="token punctuation">.</span><span class="token function">onDispose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    shouldAbort <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">await</span> <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span>debounceDuration<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> shouldAbort<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>Usage would then look like this:</p>
<pre class="language-dart"><code class="language-dart"><span class="highlight-line"><span class="token keyword">final</span> itemProvider <span class="token operator">=</span> <span class="token class-name">FutureProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token comment">// Get the search query that the user entered</span></span><br><span class="highlight-line">    <span class="token keyword">final</span> query <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>queryProvider<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">providerDebounce</span><span class="token punctuation">(</span>_debounceDuration<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token comment">// return a dummy value</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">}</span></mark><br><span class="highlight-line">    </span><br><span class="highlight-line">    <span class="token comment">// Fetch the items</span></span><br><span class="highlight-line">    <span class="token keyword">return</span> <span class="token function">fetchItems</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>

    <hr>
    <div class="post-footer">
      <div class="prev-post">
          <a class="animated-rainbow-hover" href="/posts/flutter-infinite-lists/">
            <div class="icon baseline">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
              </svg>
            </div>
            Displaying Paginated APIs as Infinite Lists</a>
        
      </div>
      <div class="next-post">
          <a class="animated-rainbow-hover" href="/posts/riverpod-refresh/">Refresh FutureProvider.family or Multiple Providers
            <div class="icon baseline">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 5l7 7-7 7M5 5l7 7-7 7"/>
              </svg>
            </div>
          </a>
        
      </div>
    </div>
    </main>

    <footer>
      <div>Michael Debertol</div>
      <div class="footer-text">
        © 2022 Michael Debertol, All rights reserved
      </div>
      <div class="footer-text">
        <a href="https://github.com/miDeb/personal-blog">Source code on GitHub</a>
      </div>
    </footer>

  </body>
</html>
