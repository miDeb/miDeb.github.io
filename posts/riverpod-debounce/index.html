<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debouncing a FutureProvider</title>
    <link rel="shortcut icon" type="image/jpg" href="/img/favicon.png"/>
    <meta name="description" content="A quick quide on how to implement a debounce functionality for a FutureProvider">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Michael Debertol">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Michael Debertol">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">Michael Debertol</a></h1>
      <ul class="nav">
        <li class="nav-item "><a href="/">Home</a></li>
        <li class="nav-item "><a href="/tags/">Tags</a></li>
        <li class="nav-item "><a href="/about/">About</a></li>
      </ul>
    </header>

    <main  class="tmpl-post">
      <h1>Debouncing a FutureProvider</h1>

<time datetime="2022-06-16">16. Juni 2022</time><a href="/tags/flutter/" class="post-tag animated-rainbow-hover">Flutter</a><a href="/tags/riverpod/" class="post-tag animated-rainbow-hover">Riverpod</a>

<p>Note: This is mostly copied from an <a href="https://github.com/rrousselGit/riverpod/blob/master/examples/marvel/lib/src/screens/home.dart">official example</a>.</p>
<h2 id="when-to-debounce" tabindex="-1"><a class="direct-link" href="#when-to-debounce">When to Debounce</a></h2>
<p>Debouncing can be useful whenever a provider relies on user input that can change quickly, like a search query.</p>
<h2 id="how-to-debounce" tabindex="-1"><a class="direct-link" href="#how-to-debounce">How to Debounce</a></h2>
<p>Let's look right at the code:</p>
<pre class="language-dart"><code class="language-dart"><span class="token comment">/// This exception indicates that a request has been aborted.</span><br><span class="token keyword">class</span> <span class="token class-name">AbortedException</span> <span class="token keyword">implements</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br><br><span class="token keyword">final</span> itemProvider <span class="token operator">=</span> <span class="token class-name">FutureProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><br>  <span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Get the search query that the user entered</span><br>    <span class="token keyword">final</span> query <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>queryProvider<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// If this provider is destroyed (i.e. a new provider for a different request is created),</span><br>    <span class="token comment">// we should abort this request.</span><br>    <span class="token keyword">var</span> shouldAbort <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>    ref<span class="token punctuation">.</span><span class="token function">onDispose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      shouldAbort <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">await</span> <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span>_debounceDuration<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldAbort<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">throw</span> <span class="token class-name">AbortedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <br>    <span class="token comment">// Fetch the items</span><br>    <span class="token keyword">return</span> <span class="token function">fetchItems</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><a href="https://pub.dev/documentation/riverpod/latest/riverpod/Ref/onDispose.html"><code>ref.onDispose</code></a> allows us to register a callback that is triggered whenever a provider is about to be destroyed.
The provider will be destroyed whenever a new provider is created for a different query. If, after a delay, we notice that the provider has been destroyed, we can abort the request.
Aborting can be done by throwing an <code>Exception</code> from the provider. In this example we're creating a custom <code>AbortedException</code> class that makes
our code a bit more readable and makes it clear that we're throwing it to abort the request, not because of an actual error.
Since at this point no one is waiting anymore for the provider that was just disposed, we can safely throw an <code>Exception</code> without it affecting the rest of the app.</p>
<h2 id="creating-a-convenience-method" tabindex="-1"><a class="direct-link" href="#creating-a-convenience-method">Creating a Convenience Method</a></h2>
<p>We can extract the logic from above into a convenience method that we can reuse:</p>
<pre class="language-dart"><code class="language-dart"><span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">void</span><span class="token punctuation">></span></span> <span class="token function">providerDebounce</span><span class="token punctuation">(</span><span class="token class-name">Duration</span> debounceDuration<span class="token punctuation">,</span> <span class="token class-name">Ref</span> ref<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> shouldAbort <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>  ref<span class="token punctuation">.</span><span class="token function">onDispose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    shouldAbort <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">await</span> <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span>debounceDuration<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldAbort<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">throw</span> <span class="token class-name">AbortedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>

<hr>
<div class="post-footer">
  <div class="prev-post">&#9194; <a class="animated-rainbow-hover" href="/posts/flutter-infinite-lists/">Displaying Paginated APIs as Infinite Lists</a></div>
  <div class="next-post"><a class="animated-rainbow-hover" href="/posts/riverpod-refresh/">Refresh All FutureProvider.family or Multiple Providers</a> &#9193;</div>
</div>

    </main>

    <footer>
      <div>Michael Debertol</div>
      <div class="footer-text">
        Â© 2022 Michael Debertol, All rights reserved
      </div>
      <div class="footer-text">
        <a href="https://github.com/miDeb/personal-blog">Source code on GitHub</a>
      </div>
    </footer>

  </body>
</html>
