{
  "version": "https://jsonfeed.org/version/1.1",
  "title": "Michael Debertol",
  "language": "en",
  "home_page_url": "https://blog.debertol.com/",
  "feed_url": "https://blog.debertol.com/feed/feed.json",
  "description": "Blog about Flutter and other stuff",
  "author": {
    "name": "Michael Debertol",
    "url": "https://blog.debertol.com/about/"
  },
  "items": [{
      "id": "https://blog.debertol.com/posts/lox-jit/",
      "url": "https://blog.debertol.com/posts/lox-jit/",
      "title": "loxjit: A Simple JIT Compiler For Lox",
      "content_html": "<h2 id=\"starting-point:-a-bytecode-virtual-machine\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/lox-jit/#starting-point:-a-bytecode-virtual-machine\">Starting Point: A Bytecode Virtual Machine</a></h2>\n<p>A bytecode VM works by first compiling a program to bytecode and then executing that bytecode.\nThe compiler breaks the program down into an array of opcodes that each represent a basic operation. These opcodes\nare only a single byte in size, which is why this representation is also called &quot;bytecode&quot;. Some opcodes also carry additional\ninformation, like the opcode to load a constant, which is always followed by an additional byte that stores the index of that constant.</p>\n<p>Bytecode is then executed by the virtual machine (VM), which walks through the individual instructions and performs the associated\noperation. The core of the VM is essentially one big <code>match</code> statement (Rust's version of a <code>switch</code> statement) in a loop.</p>\n<h2 id=\"from-compiling-bytecode-to-compiling-machine-code\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/lox-jit/#from-compiling-bytecode-to-compiling-machine-code\">From Compiling Bytecode to Compiling Machine Code</a></h2>\n<p>A bytecode VM is conceptually very similar to an actual CPU. A CPU also executes a list of instructions one after the other <span class=\"gray\">(well, actually,\nfor optimization purposes CPUs don't execute instructions strictly in order, but we won't get into that)</span>. CPUs obviously don't understand the bytecode we defined\nfor our little language, the're made for an architecture specific machine code. Real compilers have different backends to support multiple architectures\n<span class=\"gray\">(such as x64, ARM or RISC-V)</span>, but we will focus on only one of them, x64 <span class=\"gray\">(because that's what my computer is running on right now)</span>. We can expect\nthe CPU to execute machine code faster than the VM can execute bytecode. This is because the CPU is now directly executing compiled lox code, instead\nof executing an interpreter that in turn executes lox code. CPUs are also really well optimized, and we can now directly benefit from those optimizations.</p>\n<p>&quot;Crafting Interpreters&quot; already provides us with a bytecode virtual machine (<code>clox</code>) that we can use as a starting point to compile to machine code.\nThere is already a compiler that emits bytecode. We'll just have to modify it to emit machine code instead! I didn't want to write my own assembler,\nso I used <code>dynasm-rs</code> to translate assembly to actual machine code. With that out of the way, we'll have to modify the compiler just so that it emits\nassembly code. To do that, I chose the easy path and more or less translated what the interpreter was doing to assembly code. <a href=\"https://godbolt.org/\">Compiler Explorer</a> is a great\ntool to help with that. And just like that, <code>loxjit</code> was born.</p>\n<h2 id=\"differences\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/lox-jit/#differences\">Differences</a></h2>\n<h3 id=\"the-stack\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/lox-jit/#the-stack\">The Stack</a></h3>\n<p>Some things however are different with assembly than with bytecode: While the VM knows of its current call frame and has its own stack of values, our implementation\nhas to use the native stack. The native stack is also used for other things, like storing the return address of functions <span class=\"gray\">(this is mandated by the x64 architecture itself -\nthe <code>call</code> instruction pushes the current instruction pointer to the stack and the <code>ret</code> instruction restores it)</span>. We also use the stack to store\nthe pointer to the function we're in, and the pointer to the base of the current call frame, when calling a function. When the function returns, they will again be restored.\nSomething to keep in mind is that the native stack grows downwards instead of upwards, which means that pushing something to the stack <span class=\"gray\">(using the <code>push</code> instruction)</span> will decrement\nthe pointer to the last value on the stack <span class=\"gray\">(this pointer is called the &quot;stack pointer&quot; and is stored in its own register)</span>.</p>\n<h3 id=\"vm-calls\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/lox-jit/#vm-calls\">VM Calls</a></h3>\n<p>I did not implement everything in assembly. Some things, like the garbage collector or the code to print a value to the console, are still written in the host language (Rust).\nRust functions can be called from the assembly if we assign them a specific calling convention <span class=\"gray\">(Rust does not have a stable ABI, so we have to use something foreign)</span>. I chose to use\nthe <code>win64</code> calling convention, because that one seems to be supported on most platforms. Depending on the calling convention certain registers are volatile or non-volatile\n<span class=\"gray\">(volatile registers can be overwritten by a called function)</span>\nand different registers are used to pass arguments and return values. Something I didn't initially know was that the stack also had to be aligned by 16 bytes before calling.</p>\n<h3 id=\"constants\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/lox-jit/#constants\">Constants</a></h3>\n<p><code>clox</code> has a constant table where all the constants are stored. <code>loxjit</code> compiles all constants into the machine code. This means the number of constants is now essentially unlimited.</p>\n<h3 id=\"garbage-collection\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/lox-jit/#garbage-collection\">Garbage Collection</a></h3>\n<p>Garbage collection isn't actually that different. Instead of walking the custom stack the GC has to go through the native stack, which is exactly the same.\nDue to lox's value representation it will interpret all the extra pointers lying around on the stack <span class=\"gray\">(return addresses, etc.)</span> as floating point values\nand ignore them for garbage collection.</p>\n<h2 id=\"optimizations\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/lox-jit/#optimizations\">Optimizations</a></h2>\n<p>Compiling to native code already is a performance improvement, but there's some more things I did:</p>\n<h3 id=\"accessing-globals-without-hash-lookups\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/lox-jit/#accessing-globals-without-hash-lookups\">Accessing Globals Without Hash Lookups</a></h3>\n<p><code>clox</code> uses HashMap lookups to read/write global variables. <code>loxjit</code> instead assigns each global variable an index and looks it up in an array.\nThe only remaining runtime cost is to check whether the variable has been defined before. If it hasn't been defined, using it is a runtime error\nthat we need to report.</p>\n<h3 id=\"string-keys\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/lox-jit/#string-keys\">String Keys</a></h3>\n<p>Since all strings are interned by the VM we can avoid using the whole string as a key for property lookups.\nInstead, we can use the pointer to the string's buffer as a key and speed up hash lookups. <br /><span class=\"gray\">I should note that\nthis optimization is only applicable because I'm not using the HashMap from the book but the one from the Rust\nstandard library. I'm pretty sure the book's implementation wouldn't have to rely on such an optimization as it\ncaches the hash in the string object itself.</span></p>\n<h3 id=\"shapes-and-inline-caches\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/lox-jit/#shapes-and-inline-caches\">Shapes and Inline Caches</a></h3>\n<h4 id=\"how-it-works\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/lox-jit/#how-it-works\">How It Works</a></h4>\n<p>So far we have only talked about compiling some code and then running it. But what if we change the code while running it,\nto make it faster? This is where Inline Caches (ICs) come into play. They use the fact that while it is theoretically possible to\npass totally random objects around in a dynamic programming language, this rarely happens. Instead, in most cases, a certain place\nin the code will always see the same kind of object repeatedly. This allows us to change code from always going <em>&quot;We need property 'foo' of\nthis object -&gt; look it up in the HashMap -&gt; found!&quot;</em> to going <em>&quot;Is it the same kind of object as before -&gt; if so, the property we're looking\nfor must be at the same index as before -&gt; found!&quot;</em>.</p>\n<p>You might have noticed the main difference: Instead of performing a hash lookup we only perform a lookup by index.\nAnother thing that might have caught your eye is the part where the new code checks for the &quot;kind of object&quot; it is. This is called the &quot;shape&quot; of an object (an alternative\nname would be &quot;hidden class&quot;). The shape of an object describes how it is laid out, i.e. at what index a property with a certain name can be found. The object itself only\ncontains an array of properties that we can index into.</p>\n<p>To make this work we need to make sure that objects that look the same also have the same <code>shape</code> assigned to them. This is achieved using a\ntree of shapes that makes sure that objects that have the same properties added to them in the same order end up with the same <code>shape</code>. <span class=\"gray\">Other implementations\nmight use more sophisticated techniques, but this seemed good enough for me.</span></p>\n<h4 id=\"example-with-get_property\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/lox-jit/#example-with-get_property\">Example With <code>get_property</code></a></h4>\n<p>Enough said, let's look at how an Inline Cache actually looks!</p>\n<p>This is my the inline cache for <code>get_property</code> <span class=\"gray\">(more or less)</span>:</p>\n<pre class=\"language-nasm\"><code class=\"language-nasm\"><span class=\"highlight-line\"><span class=\"token comment\">; rax = receiver.shape</span></span><br /><span class=\"highlight-line\">mov <span class=\"token register variable\">rax</span>, QWORD <span class=\"token operator\">[</span><span class=\"token register variable\">rcx</span> <span class=\"token operator\">+</span> <span class=\"token number\">0x10</span><span class=\"token operator\">]</span></span><br /><span class=\"highlight-line\"><span class=\"token comment\">; r8 = cached shape pointer</span></span><br /><mark class=\"highlight-line highlight-line-active\">mov <span class=\"token register variable\">r8</span>, QWORD <span class=\"token number\">0</span></mark><br /><span class=\"highlight-line\">cmp <span class=\"token register variable\">r8</span>, <span class=\"token register variable\">rax</span></span><br /><span class=\"highlight-line\"><span class=\"token comment\">; No match, jump to the slow path</span></span><br /><span class=\"highlight-line\">jne <span class=\"token operator\">></span>ic_end</span><br /><span class=\"highlight-line\"><span class=\"token comment\">; rax = receiver.fields</span></span><br /><span class=\"highlight-line\">mov <span class=\"token register variable\">rax</span>, QWORD <span class=\"token operator\">[</span><span class=\"token register variable\">rcx</span> <span class=\"token operator\">+</span> <span class=\"token number\">0x18</span><span class=\"token operator\">]</span></span><br /><span class=\"highlight-line\"><span class=\"token comment\">; rax = fields[0]</span></span><br /><mark class=\"highlight-line highlight-line-active\">mov <span class=\"token register variable\">rax</span>, QWORD <span class=\"token operator\">[</span><span class=\"token register variable\">rax</span> <span class=\"token operator\">+</span> <span class=\"token number\">0</span><span class=\"token operator\">]</span></mark><br /><span class=\"highlight-line\"><span class=\"token comment\">; store the result on the stack</span></span><br /><span class=\"highlight-line\">mov QWORD <span class=\"token operator\">[</span><span class=\"token register variable\">rsp</span> <span class=\"token operator\">+</span> <span class=\"token operator\">$</span>stack_offset<span class=\"token operator\">]</span>, <span class=\"token register variable\">rax</span></span><br /><span class=\"highlight-line\"><span class=\"token comment\">; Jump over the slow path</span></span><br /><span class=\"highlight-line\">jmp <span class=\"token operator\">></span>ok</span><br /><span class=\"highlight-line\"></span><br /><span class=\"highlight-line\"><span class=\"token label function\">ic_end:</span></span></code></pre>\n<p>The inline cache is part of the compiled output from the very beginning, but only after a <code>property_get</code> has succeeded on the slow path it will be enabled.\nAs you can see, initially the cached shape pointer is set to <code>0</code>. This makes sure that the Inline Cache is ignored before it is enabled, because <code>0</code> can\nnever be a valid pointer to a shape.\nTo enable it, we set the shape pointer and the property index <span class=\"gray\">(I've highlighted the relevant lines)</span>. Now, if the same property access is\nrun again with a receiver of the same shape, it will hit the inline cache and be much faster than the first time.</p>\n<h2 id=\"performance-evaluation\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/lox-jit/#performance-evaluation\">Performance Evaluation</a></h2>\n<p>Let's look at two benchmarks to determine the improvement we got:</p>\n<h3 id=\"slow-fibonacci\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/lox-jit/#slow-fibonacci\">Slow Fibonacci</a></h3>\n<p>Running this code:</p>\n<pre class=\"language-kt\"><code class=\"language-kt\"><span class=\"token punctuation\">{</span><br />  <span class=\"token keyword\">fun</span> <span class=\"token function\">fib</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> n<span class=\"token punctuation\">;</span><br />    <span class=\"token keyword\">return</span> <span class=\"token function\">fib</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">fib</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br />  <span class=\"token punctuation\">}</span><br />  <br />  <span class=\"token keyword\">var</span> start <span class=\"token operator\">=</span> <span class=\"token function\">clock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br />  print <span class=\"token function\">fib</span><span class=\"token punctuation\">(</span><span class=\"token number\">35</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">9227465</span><span class=\"token punctuation\">;</span><br />  print <span class=\"token function\">clock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start<span class=\"token punctuation\">;</span><br /><span class=\"token punctuation\">}</span></code></pre>\n<p>Produces these results:</p>\n<p><img src=\"https://blog.debertol.com/img/loxjit-perf-fib.svg\" /></p>\n<p>The performance improvement we see here is the result of compiling to machine code, which is most noticeable\nin code like this that does a lot simple numeric operations and function calls. Unsurprisingly, enabling inline caches has\nno effect here because ICs are only used for property access and method calls, which this code has exactly zero.</p>\n<h3 id=\"property-accesses-and-method-calls\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/lox-jit/#property-accesses-and-method-calls\">Property Accesses and Method Calls</a></h3>\n<p>You can find the whole benchmark <a href=\"https://github.com/munificent/craftinginterpreters/blob/01e6f5b8f3e5dfa65674c2f9cf4700d73ab41cf8/test/benchmark/properties.lox\">here</a>,\nbut it essentially looks like this:</p>\n<pre class=\"language-kt\"><code class=\"language-kt\"><span class=\"token keyword\">class</span> Foo <span class=\"token punctuation\">{</span><br />  <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>field0 <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span><br />    <span class=\"token comment\">// ...</span><br />    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>field29 <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span><br />  <span class=\"token punctuation\">}</span><br /><br />  <span class=\"token function\">method0</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>field0<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><br />  <span class=\"token comment\">// ...</span><br />  <span class=\"token function\">method29</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>field29<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><br /><span class=\"token punctuation\">}</span><br /><br /><span class=\"token keyword\">var</span> foo <span class=\"token operator\">=</span> <span class=\"token function\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br /><span class=\"token keyword\">var</span> start <span class=\"token operator\">=</span> <span class=\"token function\">clock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br /><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span><br /><span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">&lt;</span> <span class=\"token number\">500000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />  foo<span class=\"token punctuation\">.</span><span class=\"token function\">method0</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br />  <span class=\"token comment\">// ...</span><br />  foo<span class=\"token punctuation\">.</span><span class=\"token function\">method29</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br />  i <span class=\"token operator\">=</span> i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span><br /><span class=\"token punctuation\">}</span><br /><br />print <span class=\"token function\">clock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start<span class=\"token punctuation\">;</span></code></pre>\n<p>The results are:</p>\n<p><img src=\"https://blog.debertol.com/img/loxjit-perf-props.svg\" /></p>\n<p>Performance is dominated by HashMap lookups here, and it doesn't matter if the HashMap lookup is initiated by an interpreter or natively compiled code - it\nwill always be rather slow. I guess most of the performance improvement for <code>loxjit (without ICs)</code> vs <code>clox</code> comes from the different HashMap used\n<span class=\"gray\">(<code>loxjit</code> uses <code>hashbrown</code> from the standard library)</span>. Where we do see a nice improvement is when ICs are enabled, as this benchmark\ncan be optimized really well using inline caches: Since the same property access is performed over and over again, apart from the first run no further HashMap lookups\nhave to be performed.</p>\n<h2 id=\"conclusion\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/lox-jit/#conclusion\">Conclusion</a></h2>\n<p><a href=\"https://blog.debertol.com/posts/lox-jit/craftinginterpreters.com\">Crafting Interpreters</a> is a great book if you want to learn more about how programming languages can be created.\nIt is also a great starting point if you want to do some exploration on your own, as I've tried to show in this blog post.</p>\n<p>If you notice something wrong in this post or if you have other comments please feel free to <a href=\"https://github.com/miDeb/personal-blog/issues\">open an issue</a>\nor reach out via email (can be found <a href=\"https://github.com/miDeb\">here</a>).</p>\n<p>The source code for <code>loxjit</code> can be found <a href=\"https://github.com/miDeb/loxjit\">here</a>.</p>\n",
      "date_published": "2022-12-07T00:00:00Z"
    },{
      "id": "https://blog.debertol.com/posts/riverpod-refresh/",
      "url": "https://blog.debertol.com/posts/riverpod-refresh/",
      "title": "Refreshing FutureProvider.family or Multiple Providers",
      "content_html": "<p>I recently wondered how you could easily refresh a <code>FutureProvider</code>.\nHad I read the docs, I would have known of <a href=\"https://pub.dev/documentation//flutter_riverpod/latest/flutter_riverpod/WidgetRef/refresh.html\"><code>ref.refresh</code></a>.\nNonetheless, the solution I came up with is a bit more general and can be applied even for <code>FutureProvider.family</code> or multiple <code>FutureProvider</code>s.</p>\n<h2 id=\"creating-a-refreshprovider\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/riverpod-refresh/#creating-a-refreshprovider\">Creating a <code>refreshProvider</code></a></h2>\n<p>The main idea is to create a <code>refreshProvider</code> that other providers can watch.\nWhen the <code>refreshProvider</code> refreshes, all other providers will be refreshed too.</p>\n<p>One way of creating such a <code>refreshProvider</code> is to use a <code>ChangeNotifierProvider</code>:</p>\n<pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token keyword\">import</span> <span class=\"token string-literal\"><span class=\"token string\">'package:flutter/foundation.dart'</span></span><span class=\"token punctuation\">;</span><br /><span class=\"token keyword\">import</span> <span class=\"token string-literal\"><span class=\"token string\">'package:flutter_riverpod/flutter_riverpod.dart'</span></span><span class=\"token punctuation\">;</span><br /><br /><span class=\"token keyword\">class</span> <span class=\"token class-name\">RefreshNotifier</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ChangeNotifier</span> <span class=\"token punctuation\">{</span><br />  <span class=\"token keyword\">void</span> <span class=\"token function\">refresh</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />    <span class=\"token function\">notifyListeners</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br />  <span class=\"token punctuation\">}</span><br /><span class=\"token punctuation\">}</span><br /><br /><span class=\"token keyword\">final</span> refreshProvider <span class=\"token operator\">=</span> <span class=\"token class-name\">ChangeNotifierProvider</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">RefreshNotifier</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><br />  <span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token class-name\">RefreshNotifier</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><br /><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Other providers can watch it, for example:</p>\n<pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"highlight-line\"><span class=\"token keyword\">final</span> itemProvider <span class=\"token operator\">=</span> <span class=\"token class-name\">FutureProvider</span><span class=\"token punctuation\">.</span>family<span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Item</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">,</span> int<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">  <span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">,</span> page<span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span></span><br /><mark class=\"highlight-line highlight-line-active\">    ref<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span>refreshProvider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></mark><br /><span class=\"highlight-line\">    <span class=\"token keyword\">final</span> items <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetchItems</span><span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">return</span> items<span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\"><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></code></pre>\n<p>And here's the code needed to trigger a refresh:</p>\n<pre class=\"language-dart\"><code class=\"language-dart\">ref<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>refreshProvider<span class=\"token punctuation\">.</span>notifier<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">refresh</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>That's it! But keep in mind: For simpler usecases <code>ref.refresh</code> is the better choice.</p>\n",
      "date_published": "2022-06-16T00:00:00Z"
    },{
      "id": "https://blog.debertol.com/posts/riverpod-debounce/",
      "url": "https://blog.debertol.com/posts/riverpod-debounce/",
      "title": "Debouncing a FutureProvider",
      "content_html": "<p>Note: This is mostly copied from an <a href=\"https://github.com/rrousselGit/riverpod/blob/master/examples/marvel/lib/src/screens/home.dart\">official example</a>.</p>\n<h2 id=\"when-to-debounce\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/riverpod-debounce/#when-to-debounce\">When to Debounce</a></h2>\n<p>Debouncing can be useful whenever a provider relies on user input that can change quickly, like a search query.</p>\n<h2 id=\"how-to-debounce\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/riverpod-debounce/#how-to-debounce\">How to Debounce</a></h2>\n<p>Let's look right at the code:</p>\n<pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"highlight-line\"><span class=\"token comment\">/// This exception indicates that a request has been aborted.</span></span><br /><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">AbortedException</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></span><br /><span class=\"highlight-line\"></span><br /><span class=\"highlight-line\"><span class=\"token keyword\">final</span> itemProvider <span class=\"token operator\">=</span> <span class=\"token class-name\">FutureProvider</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Item</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">  <span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span></span><br /><span class=\"highlight-line\">    <span class=\"token comment\">// Get the search query that the user entered</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">final</span> query <span class=\"token operator\">=</span> ref<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span>queryProvider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\"></span><br /><mark class=\"highlight-line highlight-line-active\">    <span class=\"token comment\">// If this provider is destroyed (i.e. a new provider for a different</span></mark><br /><mark class=\"highlight-line highlight-line-active\">    <span class=\"token comment\">// request is created), we should abort this request.</span></mark><br /><mark class=\"highlight-line highlight-line-active\">    <span class=\"token keyword\">var</span> shouldAbort <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></mark><br /><mark class=\"highlight-line highlight-line-active\">    ref<span class=\"token punctuation\">.</span><span class=\"token function\">onDispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></mark><br /><mark class=\"highlight-line highlight-line-active\">      shouldAbort <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></mark><br /><mark class=\"highlight-line highlight-line-active\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></mark><br /><mark class=\"highlight-line highlight-line-active\">    <span class=\"token keyword\">await</span> <span class=\"token class-name\">Future</span><span class=\"token punctuation\">.</span><span class=\"token function\">delayed</span><span class=\"token punctuation\">(</span>_debounceDuration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></mark><br /><mark class=\"highlight-line highlight-line-active\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shouldAbort<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></mark><br /><mark class=\"highlight-line highlight-line-active\">      <span class=\"token comment\">// TODO: abort</span></mark><br /><mark class=\"highlight-line highlight-line-active\">    <span class=\"token punctuation\">}</span></mark><br /><span class=\"highlight-line\">    </span><br /><span class=\"highlight-line\">    <span class=\"token comment\">// Fetch the items</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">return</span> <span class=\"token function\">fetchItems</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\"><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></code></pre>\n<p><a href=\"https://pub.dev/documentation/riverpod/latest/riverpod/Ref/onDispose.html\"><code>ref.onDispose</code></a> allows us to register a callback that is triggered whenever a provider is about to be destroyed.\nThe provider will be destroyed whenever a new provider is created for a different query. If, after a delay, we notice that the provider has been destroyed, we can abort the request.</p>\n<h2 id=\"aborting-a-request-by-throwing-an-exception\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/riverpod-debounce/#aborting-a-request-by-throwing-an-exception\">Aborting a Request by Throwing an Exception</a></h2>\n<p>One way to abort a request is by throwing an exception:</p>\n<pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"highlight-line\"><span class=\"token comment\">/// This exception indicates that a request has been aborted.</span></span><br /><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">AbortedException</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></span><br /><span class=\"highlight-line\"></span><br /><span class=\"highlight-line\"><span class=\"token keyword\">final</span> itemProvider <span class=\"token operator\">=</span> <span class=\"token class-name\">FutureProvider</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Item</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">  <span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span></span><br /><span class=\"highlight-line\">    <span class=\"token comment\">// Get the search query that the user entered</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">final</span> query <span class=\"token operator\">=</span> ref<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span>queryProvider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\"></span><br /><span class=\"highlight-line\">    <span class=\"token comment\">// If this provider is destroyed (i.e. a new provider for a different</span></span><br /><span class=\"highlight-line\">    <span class=\"token comment\">// request is created), we should abort this request.</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">var</span> shouldAbort <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">    ref<span class=\"token punctuation\">.</span><span class=\"token function\">onDispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br /><span class=\"highlight-line\">      shouldAbort <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">await</span> <span class=\"token class-name\">Future</span><span class=\"token punctuation\">.</span><span class=\"token function\">delayed</span><span class=\"token punctuation\">(</span>_debounceDuration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shouldAbort<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br /><mark class=\"highlight-line highlight-line-active\">      <span class=\"token keyword\">throw</span> <span class=\"token class-name\">AbortedException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></mark><br /><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span></span><br /><span class=\"highlight-line\">    </span><br /><span class=\"highlight-line\">    <span class=\"token comment\">// Fetch the items</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">return</span> <span class=\"token function\">fetchItems</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\"><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></code></pre>\n<p>In this example we're creating a custom <code>AbortedException</code> class that makes\nour code a bit more readable and makes it clear that we're throwing an Exception to abort the request, not because of an actual error.</p>\n<p>Since the provider was disposed its result will be ignored and throwing an <code>Exception</code> will not affect the rest of the app.\nIt will however show up when you debug the app and you have &quot;break on exceptions&quot; enabled, which can be a bit annoying.</p>\n<h3 id=\"creating-a-convenience-method\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/riverpod-debounce/#creating-a-convenience-method\">Creating a Convenience Method</a></h3>\n<p>This approach is very general and we can extract the logic from above into a convenience method that we can reuse:</p>\n<pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">AbortedException</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><br /><br /><span class=\"token class-name\">Future</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">providerDebounce</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Duration</span> debounceDuration<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Ref</span> ref<span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span><br />  <span class=\"token keyword\">var</span> shouldAbort <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span><br />  ref<span class=\"token punctuation\">.</span><span class=\"token function\">onDispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />    shouldAbort <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span><br />  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br />  <span class=\"token keyword\">await</span> <span class=\"token class-name\">Future</span><span class=\"token punctuation\">.</span><span class=\"token function\">delayed</span><span class=\"token punctuation\">(</span>debounceDuration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br />  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shouldAbort<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />    <span class=\"token keyword\">throw</span> <span class=\"token class-name\">AbortedException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br />  <span class=\"token punctuation\">}</span><br /><span class=\"token punctuation\">}</span></code></pre>\n<p>Debouncing is now as straightforward as calling <code>await providerDebounce(_debounceDuration, ref);</code> in the provider.</p>\n<p>Our <code>itemProvider</code> would now look like this:</p>\n<pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"highlight-line\"><span class=\"token keyword\">final</span> itemProvider <span class=\"token operator\">=</span> <span class=\"token class-name\">FutureProvider</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Item</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">  <span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span></span><br /><span class=\"highlight-line\">    <span class=\"token comment\">// Get the search query that the user entered</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">final</span> query <span class=\"token operator\">=</span> ref<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span>queryProvider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\"></span><br /><mark class=\"highlight-line highlight-line-active\">    <span class=\"token keyword\">await</span> <span class=\"token function\">providerDebounce</span><span class=\"token punctuation\">(</span>_debounceDuration<span class=\"token punctuation\">,</span> ref<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></mark><br /><span class=\"highlight-line\">    </span><br /><span class=\"highlight-line\">    <span class=\"token comment\">// Fetch the items</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">return</span> <span class=\"token function\">fetchItems</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\"><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></code></pre>\n<h2 id=\"aborting-without-exceptions\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/riverpod-debounce/#aborting-without-exceptions\">Aborting Without Exceptions</a></h2>\n<p>Instead of throwing an <code>Exception</code> to abort we can also return a dummy value:</p>\n<pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"highlight-line\"><span class=\"token keyword\">final</span> itemProvider <span class=\"token operator\">=</span> <span class=\"token class-name\">FutureProvider</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Item</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">  <span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span></span><br /><span class=\"highlight-line\">    <span class=\"token comment\">// Get the search query that the user entered</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">final</span> query <span class=\"token operator\">=</span> ref<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span>queryProvider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\"></span><br /><span class=\"highlight-line\">    <span class=\"token comment\">// If this provider is destroyed (i.e. a new provider for a different</span></span><br /><span class=\"highlight-line\">    <span class=\"token comment\">// request is created), we should abort this request.</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">var</span> shouldAbort <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">    ref<span class=\"token punctuation\">.</span><span class=\"token function\">onDispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br /><span class=\"highlight-line\">      shouldAbort <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">await</span> <span class=\"token class-name\">Future</span><span class=\"token punctuation\">.</span><span class=\"token function\">delayed</span><span class=\"token punctuation\">(</span>_debounceDuration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shouldAbort<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br /><mark class=\"highlight-line highlight-line-active\">      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></mark><br /><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span></span><br /><span class=\"highlight-line\">    </span><br /><span class=\"highlight-line\">    <span class=\"token comment\">// Fetch the items</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">return</span> <span class=\"token function\">fetchItems</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\"><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></code></pre>\n<p>Here we're returning an empty list. This return value will be ignored, but most importantly, the request further down will\nnot be initiated.</p>\n<p>Another possibility is to return a <code>Future</code> that never completes. This can be achieved using <code>Completer&lt;List&lt;Item&gt;&gt;().future</code>.</p>\n<h3 id=\"creating-a-convenience-method-1\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/riverpod-debounce/#creating-a-convenience-method-1\">Creating a Convenience Method</a></h3>\n<p>For this approach a convenience method will have to look like this:</p>\n<pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token class-name\">Future</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>bool<span class=\"token punctuation\">></span></span> <span class=\"token function\">providerDebounce</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Duration</span> debounceDuration<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Ref</span> ref<span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span><br />  <span class=\"token keyword\">var</span> shouldAbort <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span><br />  ref<span class=\"token punctuation\">.</span><span class=\"token function\">onDispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />    shouldAbort <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span><br />  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br />  <span class=\"token keyword\">await</span> <span class=\"token class-name\">Future</span><span class=\"token punctuation\">.</span><span class=\"token function\">delayed</span><span class=\"token punctuation\">(</span>debounceDuration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br />  <span class=\"token keyword\">return</span> shouldAbort<span class=\"token punctuation\">;</span><br /><span class=\"token punctuation\">}</span></code></pre>\n<p>Usage would then look like this:</p>\n<pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"highlight-line\"><span class=\"token keyword\">final</span> itemProvider <span class=\"token operator\">=</span> <span class=\"token class-name\">FutureProvider</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Item</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">  <span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span></span><br /><span class=\"highlight-line\">    <span class=\"token comment\">// Get the search query that the user entered</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">final</span> query <span class=\"token operator\">=</span> ref<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span>queryProvider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\"></span><br /><mark class=\"highlight-line highlight-line-active\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> <span class=\"token function\">providerDebounce</span><span class=\"token punctuation\">(</span>_debounceDuration<span class=\"token punctuation\">,</span> ref<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></mark><br /><mark class=\"highlight-line highlight-line-active\">      <span class=\"token comment\">// return a dummy value</span></mark><br /><mark class=\"highlight-line highlight-line-active\">      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></mark><br /><mark class=\"highlight-line highlight-line-active\">    <span class=\"token punctuation\">}</span></mark><br /><span class=\"highlight-line\">    </span><br /><span class=\"highlight-line\">    <span class=\"token comment\">// Fetch the items</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">return</span> <span class=\"token function\">fetchItems</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\"><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></code></pre>\n",
      "date_published": "2022-06-16T00:00:00Z"
    },{
      "id": "https://blog.debertol.com/posts/flutter-infinite-lists/",
      "url": "https://blog.debertol.com/posts/flutter-infinite-lists/",
      "title": "Displaying Paginated APIs as Infinite Lists",
      "content_html": "<p>While there are <a href=\"https://pub.dev/packages/infinite_scroll_pagination\">packages out there</a> that provide such functionality,\nfor the sake of this blog post we'll try to implement it ourselves, using only built-in Flutter widgets.</p>\n<p>I'll be using <code>riverpod</code> for managing the state, but it should be possible to use something else as well.</p>\n<h2 id=\"why-reimplement-something-if-there's-already-a-package\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/flutter-infinite-lists/#why-reimplement-something-if-there's-already-a-package\">Why Reimplement Something if Theres Already a Package?</a></h2>\n<p>Sometimes it's just easier.\nIn my case the package mentioned above would have required changes to make it work for my usecase,\nmeaning that I would have had to fork it possibly mantain that fork in the future.</p>\n<p>Also, I was looking for something a bit simpler. If I implement something for myself,\nI can focus on the feature I need; a package has to cover many different usecases and\nwill therefore be more complex to use.</p>\n<h2 id=\"what-features-do-we-need\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/flutter-infinite-lists/#what-features-do-we-need\">What Features Do We Need?</a></h2>\n<p>In this post we'll only explore very basic options:</p>\n<ul>\n<li>The list should load new items as they become visible</li>\n<li>While loading some kind of animation should be shown. We'll be using the <a href=\"https://pub.dev/packages/shimmer\">shimmer</a> package for this.</li>\n</ul>\n<h2 id=\"how-to-manage-state\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/flutter-infinite-lists/#how-to-manage-state\">How To Manage State?</a></h2>\n<p>As already mentioned, we're using <code>riverpod</code>, so our data will come from a <code>Provider</code>.\nIt's very convenient to use <code>FutureProvider.family</code> for our usecase.</p>\n<p>Let's take a look at our provider:</p>\n<pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token keyword\">final</span> itemProvider <span class=\"token operator\">=</span>  <span class=\"token class-name\">FutureProvider</span><span class=\"token punctuation\">.</span>family<span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Item</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">,</span> int<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><br />  <span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">,</span> page<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />    <span class=\"token keyword\">return</span> <span class=\"token function\">fetchItems</span><span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br />  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br /><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br /></code></pre>\n<p>You can add more features to this provider, like <a href=\"https://blog.debertol.com/posts/riverpod-refresh\">refresh functionality</a> or <a href=\"https://blog.debertol.com/posts/riverpod-debounce\">debouncing</a>.</p>\n<h2 id=\"using-listview.custom\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/flutter-infinite-lists/#using-listview.custom\">Using <code>ListView.custom</code></a></h2>\n<p>Since we want to display a List of items, we'll probably want to look at <a href=\"https://api.flutter.dev/flutter/widgets/ListView-class.html\"><code>ListView</code></a>. Since we don't know all items\nbeforehand, let's take a closer look at <a href=\"https://api.flutter.dev/flutter/widgets/ListView/ListView.builder.html\"><code>ListView.builder</code></a>. Reading through its documentation we'll soon\ndiscover an issue: To display a list with a <strong>limited</strong> amount of items we have to provide <code>itemCount</code> - but it turns out we don't know the number of items at the beginning!\nThis is however only a minor problem: We'll have to use the lesser known <a href=\"https://api.flutter.dev/flutter/widgets/ListView/ListView.custom.html\"><code>ListView.custom</code></a> constructor,\nwhich allows us to signal that there are no more items by returning <code>null</code> from the item builder.</p>\n<p>The basic code will look like this:</p>\n<pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token class-name\">ListView</span><span class=\"token punctuation\">.</span><span class=\"token function\">custom</span><span class=\"token punctuation\">(</span><br />  childrenDelegate<span class=\"token punctuation\">:</span> <span class=\"token class-name\">SliverChildBuilderDelegate</span><span class=\"token punctuation\">(</span><br />    <span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />      <span class=\"token comment\">// TODO: implement item builder</span><br />    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br />  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><br /><span class=\"token punctuation\">)</span></code></pre>\n<h2 id=\"implementing-the-item-builder\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/flutter-infinite-lists/#implementing-the-item-builder\">Implementing The Item Builder</a></h2>\n<p>First, we have to calculate the page index and the index of the item in the page.</p>\n<pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token keyword\">final</span> pageIndex <span class=\"token operator\">=</span> index <span class=\"token operator\">~/</span> pageSize<span class=\"token punctuation\">;</span><br /><span class=\"token keyword\">final</span> itemIndex <span class=\"token operator\">=</span> index <span class=\"token operator\">%</span> pageSize<span class=\"token punctuation\">;</span></code></pre>\n<p>Then, to get the corresponding page, we can read our <code>itemProvider</code>:</p>\n<pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token keyword\">final</span> page <span class=\"token operator\">=</span> ref<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span><span class=\"token function\">itemProvider</span><span class=\"token punctuation\">(</span>pageIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p><code>page</code> is an <code>AsyncValue&lt;List&lt;Item&gt;&gt;</code> object, and it can eiter be loading, contain an error, or contain the items we wanted.\nLet's handle all those different cases:</p>\n<pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token keyword\">return</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><br />  loading<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token class-name\">LoadingTile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><br />  error<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>itemIndex <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />      <span class=\"token keyword\">return</span> <span class=\"token class-name\">Text</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'Error: </span><span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token expression\">error</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br />    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br />      <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span><br />    <span class=\"token punctuation\">}</span><br />  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br />  data<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />    <span class=\"token keyword\">final</span> items <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span><br />    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&lt;=</span> itemIndex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />      <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span><br />    <span class=\"token punctuation\">}</span><br />    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ItemTile</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">:</span> items<span class=\"token punctuation\">[</span>itemIndex<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br />  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br /><span class=\"token punctuation\">)</span></code></pre>\n<p><code>LoadingTile</code> will show a shimmer effect while the data is loading. Error handling should look a bit different in a real app,\npossibly offering a <code>retry</code> button and showing the error in a more user-friendly way.</p>\n<h2 id=\"full-example\" tabindex=\"-1\"><a class=\"direct-link\" href=\"https://blog.debertol.com/posts/flutter-infinite-lists/#full-example\">Full Example</a></h2>\n<p>That's already it! I left out some details above that are not relevant for what I wanted to show, but for the sake of completeness I'll provide\na full example below (I've highlighted the most important parts):</p>\n<pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"highlight-line\"><span class=\"token keyword\">import</span> <span class=\"token string-literal\"><span class=\"token string\">'package:flutter/material.dart'</span></span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\"><span class=\"token keyword\">import</span> <span class=\"token string-literal\"><span class=\"token string\">'package:flutter_riverpod/flutter_riverpod.dart'</span></span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\"><span class=\"token keyword\">import</span> <span class=\"token string-literal\"><span class=\"token string\">'package:shimmer/shimmer.dart'</span></span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\"></span><br /><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Item</span> <span class=\"token punctuation\">{</span></span><br /><span class=\"highlight-line\">  <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> title<span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\"></span><br /><span class=\"highlight-line\">  <span class=\"token class-name\">Item</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\"><span class=\"token punctuation\">}</span></span><br /><span class=\"highlight-line\"></span><br /><span class=\"highlight-line\"><span class=\"token keyword\">const</span> pageSize <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\"></span><br /><span class=\"highlight-line\"><span class=\"token class-name\">Future</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Item</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token function\">fetchItems</span><span class=\"token punctuation\">(</span>int page<span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span></span><br /><span class=\"highlight-line\">  <span class=\"token keyword\">return</span> <span class=\"token class-name\">Future</span><span class=\"token punctuation\">.</span><span class=\"token function\">delayed</span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">const</span> <span class=\"token class-name\">Duration</span><span class=\"token punctuation\">(</span>seconds<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\">    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">generate</span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">      <span class=\"token number\">10</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\">      <span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token class-name\">Item</span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">        <span class=\"token punctuation\">(</span>page <span class=\"token operator\">*</span> <span class=\"token number\">10</span> <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\">      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\">    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\">  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\"><span class=\"token punctuation\">}</span></span><br /><span class=\"highlight-line\"></span><br /><mark class=\"highlight-line highlight-line-active\"><span class=\"token keyword\">final</span> itemProvider <span class=\"token operator\">=</span> <span class=\"token class-name\">FutureProvider</span><span class=\"token punctuation\">.</span>family<span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Item</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">,</span> int<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span></mark><br /><mark class=\"highlight-line highlight-line-active\">  <span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">,</span> page<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></mark><br /><mark class=\"highlight-line highlight-line-active\">    <span class=\"token keyword\">return</span> <span class=\"token function\">fetchItems</span><span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></mark><br /><mark class=\"highlight-line highlight-line-active\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></mark><br /><mark class=\"highlight-line highlight-line-active\"><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></mark><br /><span class=\"highlight-line\"></span><br /><span class=\"highlight-line\"><span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br /><span class=\"highlight-line\">  <span class=\"token function\">runApp</span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">const</span> <span class=\"token class-name\">ProviderScope</span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">      child<span class=\"token punctuation\">:</span> <span class=\"token class-name\">MaterialApp</span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">        home<span class=\"token punctuation\">:</span> <span class=\"token class-name\">HomePage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\">      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\">    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\">  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\"><span class=\"token punctuation\">}</span></span><br /><span class=\"highlight-line\"></span><br /><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">LoadingTile</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">StatelessWidget</span> <span class=\"token punctuation\">{</span></span><br /><span class=\"highlight-line\">  <span class=\"token keyword\">const</span> <span class=\"token class-name\">LoadingTile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token class-name\">Key</span><span class=\"token operator\">?</span> key<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\"></span><br /><span class=\"highlight-line\">  <span class=\"token metadata function\">@override</span></span><br /><span class=\"highlight-line\">  <span class=\"token class-name\">Widget</span> <span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BuildContext</span> context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ListTile</span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">      title<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Shimmer</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromColors</span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">        baseColor<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Colors</span><span class=\"token punctuation\">.</span>grey<span class=\"token punctuation\">.</span>shade300<span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\">        highlightColor<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Colors</span><span class=\"token punctuation\">.</span>white70<span class=\"token punctuation\">.</span><span class=\"token function\">withOpacity</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\">        child<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Container</span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">          width<span class=\"token punctuation\">:</span> <span class=\"token number\">90</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\">          height<span class=\"token punctuation\">:</span> <span class=\"token number\">14</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\">          color<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Colors</span><span class=\"token punctuation\">.</span>white<span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\">        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\">      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\">    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">  <span class=\"token punctuation\">}</span></span><br /><span class=\"highlight-line\"><span class=\"token punctuation\">}</span></span><br /><span class=\"highlight-line\"></span><br /><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ItemTile</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">StatelessWidget</span> <span class=\"token punctuation\">{</span></span><br /><span class=\"highlight-line\">  <span class=\"token keyword\">final</span> <span class=\"token class-name\">Item</span> item<span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">  <span class=\"token keyword\">const</span> <span class=\"token class-name\">ItemTile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token class-name\">Key</span><span class=\"token operator\">?</span> key<span class=\"token punctuation\">,</span> required <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\"></span><br /><span class=\"highlight-line\">  <span class=\"token metadata function\">@override</span></span><br /><span class=\"highlight-line\">  <span class=\"token class-name\">Widget</span> <span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BuildContext</span> context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ListTile</span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">      title<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Text</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\">    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">  <span class=\"token punctuation\">}</span></span><br /><span class=\"highlight-line\"><span class=\"token punctuation\">}</span></span><br /><span class=\"highlight-line\"></span><br /><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">HomePage</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ConsumerWidget</span> <span class=\"token punctuation\">{</span></span><br /><span class=\"highlight-line\">  <span class=\"token keyword\">const</span> <span class=\"token class-name\">HomePage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token class-name\">Key</span><span class=\"token operator\">?</span> key<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\"></span><br /><span class=\"highlight-line\">  <span class=\"token metadata function\">@override</span></span><br /><span class=\"highlight-line\">  <span class=\"token class-name\">Widget</span> <span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BuildContext</span> context<span class=\"token punctuation\">,</span> <span class=\"token class-name\">WidgetRef</span> ref<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br /><span class=\"highlight-line\">    <span class=\"token keyword\">return</span> <span class=\"token class-name\">Scaffold</span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">      appBar<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AppBar</span><span class=\"token punctuation\">(</span></span><br /><span class=\"highlight-line\">        title<span class=\"token punctuation\">:</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">Text</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Infinite Scroll Sample\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br /><span class=\"highlight-line\">      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br /><mark class=\"highlight-line highlight-line-active\">      body<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ListView</span><span class=\"token punctuation\">.</span><span class=\"token function\">custom</span><span class=\"token punctuation\">(</span></mark><br /><mark class=\"highlight-line highlight-line-active\">        childrenDelegate<span class=\"token punctuation\">:</span> <span class=\"token class-name\">SliverChildBuilderDelegate</span><span class=\"token punctuation\">(</span></mark><br /><mark class=\"highlight-line highlight-line-active\">          <span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></mark><br /><mark class=\"highlight-line highlight-line-active\">            <span class=\"token keyword\">final</span> pageIndex <span class=\"token operator\">=</span> index <span class=\"token operator\">~/</span> pageSize<span class=\"token punctuation\">;</span></mark><br /><mark class=\"highlight-line highlight-line-active\">            <span class=\"token keyword\">final</span> itemIndex <span class=\"token operator\">=</span> index <span class=\"token operator\">%</span> pageSize<span class=\"token punctuation\">;</span></mark><br /><mark class=\"highlight-line highlight-line-active\">            <span class=\"token keyword\">final</span> page <span class=\"token operator\">=</span> ref<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span><span class=\"token function\">itemProvider</span><span class=\"token punctuation\">(</span>pageIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></mark><br /><mark class=\"highlight-line highlight-line-active\">            <span class=\"token keyword\">return</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span></mark><br /><mark class=\"highlight-line highlight-line-active\">              loading<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">LoadingTile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></mark><br /><mark class=\"highlight-line highlight-line-active\">              error<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></mark><br /><mark class=\"highlight-line highlight-line-active\">                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>itemIndex <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></mark><br /><mark class=\"highlight-line highlight-line-active\">                  <span class=\"token keyword\">return</span> <span class=\"token class-name\">Text</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'Error: </span><span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token expression\">error</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></mark><br /><mark class=\"highlight-line highlight-line-active\">                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span></mark><br /><mark class=\"highlight-line highlight-line-active\">                  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></mark><br /><mark class=\"highlight-line highlight-line-active\">                <span class=\"token punctuation\">}</span></mark><br /><mark class=\"highlight-line highlight-line-active\">              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></mark><br /><mark class=\"highlight-line highlight-line-active\">              data<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></mark><br /><mark class=\"highlight-line highlight-line-active\">                <span class=\"token keyword\">final</span> items <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span></mark><br /><mark class=\"highlight-line highlight-line-active\">                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&lt;=</span> itemIndex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></mark><br /><mark class=\"highlight-line highlight-line-active\">                  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></mark><br /><mark class=\"highlight-line highlight-line-active\">                <span class=\"token punctuation\">}</span></mark><br /><mark class=\"highlight-line highlight-line-active\">                <span class=\"token keyword\">return</span> <span class=\"token class-name\">ItemTile</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">:</span> items<span class=\"token punctuation\">[</span>itemIndex<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></mark><br /><mark class=\"highlight-line highlight-line-active\">              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></mark><br /><mark class=\"highlight-line highlight-line-active\">            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></mark><br /><mark class=\"highlight-line highlight-line-active\">          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></mark><br /><mark class=\"highlight-line highlight-line-active\">        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></mark><br /><mark class=\"highlight-line highlight-line-active\">      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></mark><br /><span class=\"highlight-line\">    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br /><span class=\"highlight-line\">  <span class=\"token punctuation\">}</span></span><br /><span class=\"highlight-line\"><span class=\"token punctuation\">}</span></span></code></pre>\n",
      "date_published": "2022-06-16T00:00:00Z"
    }
  ]
}
